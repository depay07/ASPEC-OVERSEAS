<script>
    // 1. Supabase 설정
    const SUPABASE_URL = 'https://rfiloowzyvrfzmygpjra.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmaWxvb3d6eXZyZnpteWdwanJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MjE1NDgsImV4cCI6MjA3ODk5NzU0OH0.m6OfTzgdc3YLDRWwE3ZvMAXLZYtsygcWkKxKB8HCezg';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 2. 페이지 로딩 완료 시 실행 (안전 장치 추가됨)
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // 세션 체크
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                alert("로그인이 필요합니다.");
                window.location.href = 'index.html';
                return;
            }

            // 이메일 표시 (에러 방지 처리)
            const emailEl = document.getElementById('userEmail');
            if (emailEl && session.user) {
                emailEl.innerText = session.user.email;
            }

            // [핵심] 여기서 데이터를 불러옵니다.
            await loadData();

        } catch (error) {
            console.error("초기화 오류:", error);
            // 에러가 나도 데이터 로딩은 한 번 더 시도
            loadData(); 
        }
    });

    // 3. 데이터 불러오기 및 그리기
    async function loadData() {
        const tbody = document.getElementById('listBody');
        // 로딩 표시가 깜빡거리는 것을 방지하기 위해, 데이터가 없을 때만 로딩 표시
        if (!tbody.innerHTML.trim()) {
            tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center"><i class="fa-solid fa-spinner fa-spin"></i> 로딩중...</td></tr>';
        }

        const { data, error } = await supabase.from('overseas_items').select('*').order('created_at', { ascending: false });

        if (error) {
            console.error("데이터 로드 실패:", error);
            return;
        }

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center">등록된 내역이 없습니다.</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        
        for (const row of data) {
            const date = row.created_at.split('T')[0];
            const bl = row.bl_no ? row.bl_no.replace(/ /g, '') : ''; // 공백 제거 및 null 방지

            const isNumeric = /^\d+$/.test(bl); // 숫자만 있는지 확인
            
            // 링크 설정
            let deliveryUrl = '';
            let deliveryName = '';
            // 유니패스 모바일 링크
            const unipassUrl = `https://unipass.customs.go.kr/csp/hportal/m/cargo/cargoInfo/selectCargoInfo.do?hblNo=${bl}`;

            if (isNumeric) {
                deliveryUrl = `https://www.shiptrack.co.kr/track/CJ/${bl}`;
                deliveryName = 'CJ택배';
            } else {
                deliveryUrl = `https://t.17track.net/ko#nums=${bl}`;
                deliveryName = '17TRACK';
            }
            
            let tr = `
                <tr class="hover:bg-slate-50 border-b transition group">
                    <td class="text-slate-500 text-sm text-center">${date}</td>
                    <td class="font-bold text-slate-800 text-center">${row.item_name}</td>
                    <td class="text-left pl-8">
                        <span class="font-mono text-slate-700 font-bold text-lg select-all">${bl}</span>
                    </td>
                    
                    <td class="text-center">
                        <span class="text-xs text-slate-400">${isNumeric ? '국내도착' : '해외이동'}</span>
                    </td>

                    <td class="text-center">
                        <div class="flex justify-center gap-2">
                            ${isNumeric ? 
                                `<a href="javascript:openPopup('${unipassUrl}')" class="flex items-center bg-blue-50 border border-blue-200 text-blue-700 px-3 py-1.5 rounded text-sm font-bold hover:bg-blue-100 transition" title="관세청 통관목록 상세조회">
                                    <i class="fa-solid fa-building-columns mr-1"></i> 통관상세
                                </a>` 
                                : 
                                `<span class="text-xs text-slate-300 py-2 select-none">관세청 조회불가</span>`
                            }

                            <a href="javascript:openPopup('${deliveryUrl}')" class="flex items-center bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded text-sm hover:bg-slate-800 hover:text-white transition">
                                <i class="fa-solid fa-truck mr-1"></i> ${deliveryName}
                            </a>
                        </div>
                    </td>
                    
                    <td class="text-center">
                        <button onclick="deleteItem(${row.id})" class="text-slate-300 hover:text-red-500 p-2 transition"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += tr;
        }
    }

    // 4. 신규 저장
    async function saveItem() {
        const name = document.getElementById('itemName').value;
        const bl = document.getElementById('blNo').value;
        const note = document.getElementById('note').value;

        if (!name || !bl) {
            alert("품목명과 운송장번호를 입력해주세요.");
            return;
        }
        // 숫자, 영문만 남기고 공백 제거
        const cleanBl = bl.replace(/[^a-zA-Z0-9]/g, '');

        const { error } = await supabase.from('overseas_items').insert([{ item_name: name, bl_no: cleanBl, note: note }]);

        if (error) {
            alert("저장 실패: " + error.message);
        } else {
            closeModal();
            loadData(); // 저장 후 목록 갱신
        }
    }

    // 5. 삭제
    async function deleteItem(id) {
        if (confirm("삭제하시겠습니까?")) {
            const { error } = await supabase.from('overseas_items').delete().eq('id', id);
            if (!error) loadData();
        }
    }

    // 6. 팝업 및 모달 관련 함수
    function openPopup(url) {
        const width = 450;
        const height = 700;
        const left = (window.screen.width - width) / 2;
        const top = (window.screen.height - height) / 2;
        window.open(url, 'PopupWin', `width=${width}, height=${height}, top=${top}, left=${left}, scrollbars=yes`);
    }

    function logout() {
        supabase.auth.signOut().then(() => window.location.href = 'index.html');
    }

    function openModal() {
        document.getElementById('addModal').classList.add('active');
        document.getElementById('itemName').value = '';
        document.getElementById('blNo').value = '';
        document.getElementById('note').value = '';
        setTimeout(() => document.getElementById('itemName').focus(), 100);
    }

    function closeModal() {
        document.getElementById('addModal').classList.remove('active');
    }
</script>
